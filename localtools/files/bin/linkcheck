#!/bin/sh
# $Id: linkcheck,v 1.1 2005/06/21 20:21:40 abs Exp $

# Add the following to root's cron
# @reboot                                 /usr/pkg/bin/linkcheck
# 44      *       *       *       *       /usr/pkg/bin/linkcheck

IFLIST="ippp0 tun0"
CHECK_INTERVAL=60	# Every minute
FTP_INTERVAL=1620	# Every 27 minutes. Cannot be < CHECK_INTERVAL
FTP_URL=http://news.bbc.co.uk/text_only.stm
AUDIODIR=/usr/pkg/share/local/audio

link_check()
    {
    while true ; do
	REMOTE_IP=$(ifconfig $IF | awk '$3 == "->"{print $4}')
	if [ -n "$REMOTE_IP" -a $REMOTE_IP != 0.0.0.1 ]; then
	    if ping -q -n -c 10 -o $REMOTE_IP > /dev/null ; then
		break
	    fi
	fi
	indicate_state down
	link_reset
    done
    indicate_state up
    }

link_reset()
    {
    case $IF in
	ippp*)
	    /etc/rc.d/isdnd stop
	    route delete default
	    ifconfig $IF inet 0.0.0.0 0.0.0.1 -link1 down
	    route add default 0.0.0.1 -iface
	    sleep 1
	    /etc/rc.d/isdnd start
	    sleep 9
	    ifconfig $IF link1
	    ;;
	tun*)
	    /etc/rc.d/adsl stop
	    pkill -9 ppp
	    sleep 5
 	    /etc/rc.d/adsl start
            sleep 10
	    ;;
    esac
    }

indicate_state()
    {
    [ -t 0 ] && echo "state: $1"
    if [ "$STATE" != $1 ] ; then
	STATE=$1
	mixerctl -n -w outputs.master=180
	audioplay $AUDIODIR/$STATE.wav &
    fi
    }

for IF in $IFLIST lo0 ; do
    if ifconfig $IF >/dev/null 2>&1; then
	break;
    fi
done
if [ $IF = lo0 ] ; then
    echo "No interfaces to monitor found"
    exit 1
fi

if [ "$1" = reset ] ; then
    link_reset
    exit
fi
if [ "$1" != monitor ] ; then
    # Exit if another copy is already running
    for pid in $(pgrep -fx '^/bin/sh .*linkcheck monitor') ; do
	if [ $pid != $$ ] ; then
	    exit
	fi
    done
    exec $0 monitor
fi

FTP_EVERY=$(( $FTP_INTERVAL / $CHECK_INTERVAL ))
FTP_COUNT=0
while true ; do
    link_check
    sleep $CHECK_INTERVAL
    FTP_COUNT=$(( $FTP_COUNT + 1 ))
    if [ $FTP_COUNT -ge $FTP_EVERY ] ; then
	FTP_COUNT=0
	ftp -o /dev/null $FTP_URL > /dev/null
    fi
done
